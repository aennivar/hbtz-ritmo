extends Node2D

# Defina essa constante antes do jogo começar
const in_edit_mode: bool = false
var current_level_name = "DANGO_BALANGO"

# Tempo que leva pra falling key chegar no ponto crítico
var fk_fall_time: float = 2.2
var fk_output_arr = [[], [], [], []]

var level_info = {
	"DANGO_BALANGO" = {
		"fk_times": "[[-1.30312926769257, 3.19863967895508, 7.75265293121338, 12.3937414169312, 12.8523357391357, 14.6431739807129, 16.9042175292969, 17.386030960083, 19.252335357666, 23.7860324859619, 27.1761444091797, 27.7334239959717, 28.3922908782959, 30.6446273803711, 31.0916107177734, 37.4393661499023, 39.122811126709, 39.7845809936523, 44.4256675720215, 46.6431739807129, 47.7316101074219, 48.9042175292969, 53.4930618286133, 55.774422454834, 56.2446258544922, 63.0799987792969, 64.275830078125, 64.9056671142578, 69.2245834350586, 71.7642639160156, 74.0253036499023, 78.6431777954102, 79.0930603027344, 80.9680755615234, 81.4179580688477, 83.2407272338867, 83.6906097412109, 85.4611328125, 85.9400451660156], [0.90566902160645, 5.96181373596191, 10.5477550506592, 13.5228116989136, 14.004626083374, 16.3179138183594, 20.8951480865479, 21.9284351348877, 22.6337421417236, 25.4607704162598, 30.0031745910645, 32.9259880065918, 33.4165084838867, 41.4390037536621, 42.0369155883789, 42.8902481079102, 46.0365531921387, 50.5586402893066, 52.3088424682617, 52.776146697998, 55.1445816040039, 58.0470741271973, 58.4940574645996, 62.6446273803711, 63.7417724609375, 66.6442611694336, 69.9385955810547, 72.2228591918945, 76.7884796142578, 84.3494766235352, 84.9154632568359, 86.6105239868164, 87.1677978515625], [-0.87646253108978, 5.49160985946655, 10.0253065109253, 13.5141046524048, 14.0133331298828, 15.7867572784424, 20.3726985931396, 21.4930618286133, 23.2403629302979, 24.894783782959, 29.4720180511475, 30.6330154418945, 31.1032188415527, 40.9049423217773, 43.2530601501465, 44.0744674682617, 45.5141036987305, 50.0245788574219, 51.1565521240234, 51.6470764160156, 54.601815032959, 55.7860305786133, 56.2446258544922, 63.10322265625, 64.287434387207, 66.0579574584961, 69.5032165527344, 71.7758758544922, 76.3066680908203, 84.3727005004883, 84.9038513183594, 86.6018112182617, 87.1881149291992], [1.30040817260742, 3.6253059387207, 8.23446731567383, 12.3937414169312, 12.8407257080078, 15.1017692565918, 18.0245807647705, 18.5151012420654, 19.7312477111816, 24.2446258544922, 26.0151470184326, 26.4534233093262, 28.8102500915527, 32.9492080688477, 33.428116607666, 37.866032409668, 38.6235816955566, 40.2025382995605, 44.8087966918945, 46.9972770690918, 48.2540596008301, 49.3308837890625, 53.9284370422363, 58.0586860656738, 58.5056694030762, 62.6446273803711, 63.7417724609375, 65.3004043579102, 67.1986358642578, 72.2344635009766, 74.4838989257812, 78.6344650268555, 79.1017654418945, 80.991291809082, 81.4266632080078, 83.2407272338867, 83.6906097412109, 85.4698379516602, 85.9400451660156]]",
		"music": load("res://assets/DangoBalango.ogg")
	}
}

# Called when the node enters the scene tree for the first time.
func _ready():
	
	$MusicPlayer.stream = level_info.get(current_level_name).get("music")
	$MusicPlayer.play()
	
	if in_edit_mode:
		Signals.KeyListenerPress.connect(KeyListenerPress)
	else:
		var fk_times = level_info.get(current_level_name).get("fk_times")
		var fk_times_arr = str_to_var(fk_times)
		
		var counter: int = 0
		for key in fk_times_arr:
			
			var button_name: String = ""
			match counter:
				0:
					button_name = "Esquerda"
				1:
					button_name = "Baixo"
				2:
					button_name = "Cima"
				3:
					button_name = "Direita"
			
			for delay in key:
				SpawnFallingKey(button_name, delay)
				
			counter += 1

func KeyListenerPress(button_name: String, array_num: int):
	# print(str(array_num) + " " + str($MusicPlayer.get_playback_position()))
	fk_output_arr[array_num].append($MusicPlayer.get_playback_position() - fk_fall_time)

func SpawnFallingKey(button_name: String, delay: float):
	await get_tree().create_timer(delay).timeout
	Signals.CreateFallingKey.emit(button_name)


func _on_music_player_finished():
	print(fk_output_arr)
