extends Node2D

# Defina essa constante antes do jogo começar
const in_edit_mode: bool = false
var current_level_name = "DANGO_BALANGO"

# Tempo que leva pra falling key chegar no ponto crítico
var fk_fall_time: float = 1.8
var fk_output_arr = [[], [], [], []]

var level_info = {
	"DANGO_BALANGO" = {
		"fk_times": "[[-0.03818588256836, 1.98775501251221, 4.28072566986084, 8.88988704681396, 13.4322902679443, 15.6846267700195, 16.1548301696777, 20.2270290374756, 20.7726985931396, 24.815873336792, 25.3586399078369, 30.5541030883789, 31.0330154418945, 31.7063934326172, 34.4782783508301, 38.5533782958984, 40.8260299682617, 41.4442626953125, 43.2583229064941, 43.6298400878906, 47.7484809875488, 48.845622253418, 49.9775955200195, 50.3520195007324, 54.5635368347168, 56.3021308898926, 56.8681175231934, 59.6719276428223, 68.2807266235352, 70.3066665649414, 73.2933303833008, 75.0551483154297, 77.9141036987305, 79.6933319091797, 80.2506134033203, 82.0095245361328, 82.616145324707, 84.2386428833008, 84.7727005004883, 86.5635406494141, 87.1092025756836], [0.35655326843262, 2.55374164581299, 6.55337829589844, 9.41233558654785, 13.9141046524048, 17.9659854888916, 19.1502048492432, 22.5751468658447, 23.7361442565918, 27.6312915802002, 28.7922908782959, 39.1599990844727, 45.8821784973145, 46.584578704834, 52.2502510070801, 64.1853057861328, 64.8470718383789, 70.628840637207], [0.68743772506714, 2.96009082794189, 7.09614486694336, 11.1828567504883, 15.0867111206055, 18.4478008270264, 19.5768711090088, 23.1614505767822, 24.2934238433838, 27.1291610717773, 28.3017684936523, 39.7811347961426, 45.4003631591797, 47.2144233703613, 53.4025413513184, 63.7063934326172, 65.4333755493164, 68.2807266235352, 71.0874359130859], [1.1547393321991, 3.45061225891113, 4.81478471755981, 11.6936962127686, 14.5961906433105, 16.8775512695312, 17.391291809082, 21.4983226776123, 22.0207702636719, 26.0204078674316, 26.5747844696045, 29.3902046203613, 29.8487979888916, 32.2375518798828, 33.9558288574219, 40.2484352111816, 42.0421783447266, 42.6168701171875, 44.2480728149414, 44.7182762145996, 48.2506134033203, 49.2722885131836, 51.106665802002, 51.6842643737793, 55.033740234375, 55.7361442565918, 57.3063957214356, 59.1088439941406, 68.440364074707, 72.2281143188477, 72.8347427368164, 75.5979110717773, 77.380046081543, 85.4431716918945, 86.0526992797852, 87.6722900390625, 88.25859375]]",
		"music": load("res://assets/DangoBalangoEx.ogg")
	}
}

# Called when the node enters the scene tree for the first time.
func _ready():
	
	$MusicPlayer.stream = level_info.get(current_level_name).get("music")
	$MusicPlayer.play()
	
	if in_edit_mode:
		Signals.KeyListenerPress.connect(KeyListenerPress)
	else:
		var fk_times = level_info.get(current_level_name).get("fk_times")
		var fk_times_arr = str_to_var(fk_times)
		
		var counter: int = 0
		for key in fk_times_arr:
			
			var button_name: String = ""
			match counter:
				0:
					button_name = "Esquerda"
				1:
					button_name = "Baixo"
				2:
					button_name = "Cima"
				3:
					button_name = "Direita"
			
			for delay in key:
				SpawnFallingKey(button_name, delay)
				
			counter += 1

func KeyListenerPress(button_name: String, array_num: int):
	# print(str(array_num) + " " + str($MusicPlayer.get_playback_position()))
	fk_output_arr[array_num].append($MusicPlayer.get_playback_position() - fk_fall_time)

func SpawnFallingKey(button_name: String, delay: float):
	await get_tree().create_timer(delay).timeout
	Signals.CreateFallingKey.emit(button_name)


func _on_music_player_finished():
	print(fk_output_arr)
