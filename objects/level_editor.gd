extends Node2D

# Defina essa constante antes do jogo começar
const in_edit_mode: bool = false
var current_level_name = "DANGO_BALANGO"

# Tempo que leva pra falling key chegar no ponto crítico
var fk_fall_time: float = 1.8
var fk_output_arr = [[], [], [], []]

var level_info = {
	"DANGO_BALANGO" = {
		# HARD
		"fk_times": "[[-0.25297050476074, 3.39546508789063, 4.33587284088135, 5.08181400299072, 6.55337829589844, 7.36317462921143, 9.14530582427978, 13.4439002990723, 13.8386394500732, 14.8516094207764, 15.1070301055908, 16.8688442230225, 17.9775955200195, 18.4158737182617, 20.3663494110107, 25.2831737518311, 26.0087978363037, 27.1175510406494, 27.5674373626709, 29.4859859466553, 30.0200454711914, 32.1417686462402, 34.0080711364746, 35.8772804260254, 37.9990036010742, 38.564990234375, 39.6853515625, 40.8782760620117, 41.3049423217773, 42.8316566467285, 44.291609954834, 44.8140594482422, 45.4439002990723, 45.9024955749512, 47.6933319091797, 49.4638549804688, 50.0617668151856, 51.5884811401367, 53.6579582214356, 54.2442619323731, 55.0221321105957, 56.1947395324707, 56.8478004455566, 57.3063957214356, 63.6947814941406, 64.1330596923828, 65.3579132080078, 66.5624496459961, 67.9933807373047, 70.3066665649414, 72.8782760620117, 75.1828567504883, 75.6211349487305, 79.7165557861328, 82.0298416137695, 84.3024932861328, 87.7042190551758, 88.2382766723633], [0.18530614376068, 2.8526985168457, 4.8902494430542, 7.07582778930664, 9.29333324432373, 9.62421722412109, 11.4179594039917, 11.6849882125854, 14.5961906433105, 16.2070743560791, 19.1182758331299, 19.5884811401367, 20.7610885620117, 24.8681175231934, 26.5225402832031, 29.9358722686768, 31.1404067993164, 31.7151023864746, 34.4666664123535, 36.3242637634277, 37.7319709777832, 38.9916564941406, 40.1845809936523, 40.8898880004883, 41.3049423217773, 42.277278137207, 46.584578704834, 47.1186401367188, 48.1635391235352, 49.2084342956543, 50.4245788574219, 51.1298858642578, 53.3909294128418, 53.9569160461426, 55.7158271789551, 56.8565093994141, 57.3151008605957, 61.7210876464844, 62.8414489746094, 64.8470718383789, 65.9761459350586, 67.4593231201172, 71.0235855102539, 73.3484832763672, 75.1712448120117, 77.9547378540039, 80.1954681396484, 82.4042617797852, 84.6769134521484, 86.5316116333008], [0.65551013946533, 2.40281171798706, 4.76253957748413, 6.94811744689941, 8.8666669845581, 9.42394561767578, 11.5572788238525, 11.8330156326294, 14.5758735656738, 15.7600910186768, 18.0095245361328, 18.4245807647705, 21.4112464904785, 22.8508846282959, 23.4604084014893, 24.0351020812988, 24.5807716369629, 26.0407249450684, 29.4975959777832, 30.6266662597656, 31.7267105102539, 34.4579574584961, 36.5796806335449, 37.4446250915527, 38.564990234375, 39.6853515625, 40.8985931396484, 41.3252593994141, 42.5646240234375, 46.5961906433106, 47.7165519714356, 48.8049880981445, 52.2386390686035, 52.793017578125, 54.5432197570801, 56.2382766723633, 59.1610900878906, 59.5674392700195, 61.1347839355469, 62.2638580322266, 64.8557846069336, 66.2867156982422, 67.2038986206055, 67.7147399902344, 70.6056243896484, 72.8898880004883, 75.6095230102539, 77.4003631591797, 81.0168716430664, 83.2575942993164, 85.4431716918945, 87.0105239868164], [1.22149653434753, 2.03129262924194, 4.59129257202148, 6.80879802703857, 7.20353717803955, 11.1828567504883, 13.4555103302002, 13.8386394500732, 14.8516094207764, 15.1186401367187, 17.3477546691895, 19.1414958953857, 19.6000911712646, 21.8814517974854, 22.5432197570801, 23.1092063903809, 23.727437210083, 24.3137409210205, 26.5225402832031, 28.2698413848877, 28.6965076446533, 30.5628120422363, 31.152018737793, 32.1533805847168, 34.0080711364746, 36.8263961791992, 37.1979133605957, 39.0119735717773, 40.1961891174316, 42.0102493286133, 43.1073905944824, 43.5456687927246, 44.538321685791, 45.1246253967285, 47.1389572143555, 48.1635391235352, 49.7541038513184, 52.494059753418, 53.1122886657715, 55.7158271789551, 59.1610900878906, 59.5761444091797, 63.7063934326172, 64.1533767700195, 65.3695251464844, 66.8846237182617, 68.2691146850586, 70.3066665649414, 73.3571884155273, 77.4235794067383, 77.9663497924805, 80.6772796630859, 83.0021774291992, 85.9772369384766, 86.2442657470703, 88.2266647338867]]",
		# NORMAL
		#"fk_times": "[[-0.15718822479248, 0.7832200050354, 1.98775501251221, 4.3039457321167, 7.16000003814697, 8.84634895324707, 11.7488433837891, 13.4439002990723, 13.8502494812012, 15.7804080963135, 16.1954643249512, 17.934058380127, 21.4344665527344, 21.9249889373779, 22.5635368347168, 24.9116546630859, 27.065306854248, 28.2175971984863, 31.7267105102539, 35.2038986206055, 38.6288444519043, 39.7172805786133, 43.1393196105957, 43.5253517150879, 45.4961463928223, 45.9228126525879, 47.6933319091797, 51.1705200195313, 51.6726524353027, 53.3706123352051, 55.0221321105957, 59.608073425293, 64.8470718383789, 67.6421768188477, 70.6491577148438, 72.910205078125, 79.6846267700195, 80.1519271850586, 81.9892074584961, 82.511653137207, 84.2908813476563, 84.7175476074219, 87.6839019775391], [-0.15718822479248, 0.8035373210907, 2.40281171798706, 4.56807250976563, 6.99165554046631, 9.15691585540771, 11.6298410415649, 14.5439464569092, 15.0431739807129, 15.7804080963135, 16.1954643249512, 18.4042636871338, 21.4344665527344, 21.9249889373779, 23.0018131256104, 25.2831737518311, 27.544217300415, 28.6878005981445, 32.1214515686035, 34.8526985168457, 41.3252593994141, 42.0189582824707, 45.464217376709, 45.9344207763672, 48.1954643249512, 50.0211326599121, 50.4477989196777, 52.2183219909668, 54.5635368347168, 59.1407691955566, 64.8238555908203, 66.0399963378906, 71.0439025878906, 73.3368713378906, 85.4112503051758, 85.965625, 86.5635406494141, 87.033740234375, 88.2498886108398], [0.38848061561584, 1.3172788143158, 2.80916090011597, 4.80317468643188, 6.80009098052979, 9.34848041534424, 11.3947393417358, 13.4439002990723, 13.8705665588379, 16.8891613006592, 17.4000007629395, 19.0863487243652, 20.2821762084961, 20.7291614532471, 24.2063495635986, 26.0000907897949, 29.9126522064209, 31.0010902404785, 32.5597297668457, 34.4898864746094, 40.9218132019043, 42.4775497436523, 46.5758735656738, 47.0867111206055, 49.3158294677734, 50.0211326599121, 50.4565078735352, 52.6449882507324, 56.1947395324707, 57.2744667053223, 63.7150985717773, 66.3941070556641, 75.5340606689453, 77.9024917602539, 79.6846267700195, 80.1519271850586, 81.9892074584961, 82.511653137207, 84.3024932861328, 84.7291595458984, 87.6839019775391], [0.37687082290649, 1.32598633766174, 3.38675756454468, 4.94249410629272, 6.53306121826172, 9.49650783538818, 11.1509296417236, 14.5439464569092, 15.0431739807129, 16.9007713317871, 17.3796817779541, 19.5449440002441, 20.2908851623535, 20.7175514221191, 23.6839000701904, 26.5225402832031, 29.5092060089111, 30.5744201660156, 32.9428588867188, 33.2098876953125, 34.1270744323731, 39.0119735717773, 40.1758720397949, 44.2161437988281, 44.6660301208496, 46.5758735656738, 47.0431739807129, 48.8369171142578, 51.1705200195313, 51.6726524353027, 53.829207611084, 55.7274391174316, 56.8042633056641, 63.7063934326172, 67.1081192016602, 75.1189987182617, 77.443896484375, 85.4025375366211, 85.9453079223633, 86.5635406494141, 87.0018112182617, 88.2498886108398]]",
		# EASY
		#"fk_times": "[[-0.03818588256836, 1.98775501251221, 4.28072566986084, 8.88988704681396, 13.4322902679443, 15.6846267700195, 16.1548301696777, 20.2270290374756, 20.7726985931396, 24.815873336792, 25.3586399078369, 30.5541030883789, 31.0330154418945, 31.7063934326172, 34.4782783508301, 38.5533782958984, 40.8260299682617, 41.4442626953125, 43.2583229064941, 43.6298400878906, 47.7484809875488, 48.845622253418, 49.9775955200195, 50.3520195007324, 54.5635368347168, 56.3021308898926, 56.8681175231934, 59.6719276428223, 68.2807266235352, 70.3066665649414, 73.2933303833008, 75.0551483154297, 77.9141036987305, 79.6933319091797, 80.2506134033203, 82.0095245361328, 82.616145324707, 84.2386428833008, 84.7727005004883, 86.5635406494141, 87.1092025756836], [0.35655326843262, 2.55374164581299, 6.55337829589844, 9.41233558654785, 13.9141046524048, 17.9659854888916, 19.1502048492432, 22.5751468658447, 23.7361442565918, 27.6312915802002, 28.7922908782959, 39.1599990844727, 45.8821784973145, 46.584578704834, 52.2502510070801, 64.1853057861328, 64.8470718383789, 70.628840637207], [0.68743772506714, 2.96009082794189, 7.09614486694336, 11.1828567504883, 15.0867111206055, 18.4478008270264, 19.5768711090088, 23.1614505767822, 24.2934238433838, 27.1291610717773, 28.3017684936523, 39.7811347961426, 45.4003631591797, 47.2144233703613, 53.4025413513184, 63.7063934326172, 65.4333755493164, 68.2807266235352, 71.0874359130859], [1.1547393321991, 3.45061225891113, 4.81478471755981, 11.6936962127686, 14.5961906433105, 16.8775512695312, 17.391291809082, 21.4983226776123, 22.0207702636719, 26.0204078674316, 26.5747844696045, 29.3902046203613, 29.8487979888916, 32.2375518798828, 33.9558288574219, 40.2484352111816, 42.0421783447266, 42.6168701171875, 44.2480728149414, 44.7182762145996, 48.2506134033203, 49.2722885131836, 51.106665802002, 51.6842643737793, 55.033740234375, 55.7361442565918, 57.3063957214356, 59.1088439941406, 68.440364074707, 72.2281143188477, 72.8347427368164, 75.5979110717773, 77.380046081543, 85.4431716918945, 86.0526992797852, 87.6722900390625, 88.25859375]]",
		"music": load("res://assets/DangoBalangoEx.ogg")
	}
}

# Called when the node enters the scene tree for the first time.
func _ready():
	
	$MusicPlayer.stream = level_info.get(current_level_name).get("music")
	$MusicPlayer.play()
	
	if in_edit_mode:
		Signals.KeyListenerPress.connect(KeyListenerPress)
	else:
		var fk_times = level_info.get(current_level_name).get("fk_times")
		var fk_times_arr = str_to_var(fk_times)
		
		var counter: int = 0
		for key in fk_times_arr:
			
			var button_name: String = ""
			match counter:
				0:
					button_name = "Esquerda"
				1:
					button_name = "Baixo"
				2:
					button_name = "Cima"
				3:
					button_name = "Direita"
			
			for delay in key:
				SpawnFallingKey(button_name, delay)
				
			counter += 1

func KeyListenerPress(button_name: String, array_num: int):
	# print(str(array_num) + " " + str($MusicPlayer.get_playback_position()))
	fk_output_arr[array_num].append($MusicPlayer.get_playback_position() - fk_fall_time)

func SpawnFallingKey(button_name: String, delay: float):
	await get_tree().create_timer(delay).timeout
	Signals.CreateFallingKey.emit(button_name)


func _on_music_player_finished():
	print(fk_output_arr)
